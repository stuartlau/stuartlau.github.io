---
layout: default
---

<link rel="stylesheet" href="/assets/css/movies.css">

<div class="movies-container" data-theme="light">

    {% if page.dataset %}
    {% assign dataset_str = page.dataset | append: "" %}
    {% if dataset_str == "all" %}
    {% assign year_data = site.data.movies.all %}
    {% else %}
    {% assign year_data = site.data.movies[dataset_str] %}
    {% endif %}
    {% elsif page.year %}
    {% assign year_str = page.year | append: "" %}
    {% assign year_data = site.data.movies[year_str] %}
    {% endif %}

    {% if year_data %}
    <!-- Stats -->
    <div class="movies-stats">
        <span>å…±è§‚çœ‹ <strong>{{ year_data | size }}</strong> éƒ¨ç”µå½±</span>
        {% assign total_rating = 0 %}
        {% assign rated_count = 0 %}
        {% for movie in year_data %}
        {% if movie.my_rating %}
        {% assign total_rating = total_rating | plus: movie.my_rating %}
        {% assign rated_count = rated_count | plus: 1 %}
        {% endif %}
        {% endfor %}
        {% if rated_count > 0 %}
        {% assign avg_rating = total_rating | divided_by: rated_count %}
        <span class="divider">|</span>
        <span>å¹³å‡è¯„åˆ† <strong>{{ avg_rating }}</strong> æ˜Ÿ</span>
        {% endif %}
    </div>

    <!-- View Toggle -->
    <div class="movies-controls">
        <div class="view-mode-links">
            <a href="#" class="mode-link active" data-mode="normal">å›¾ç‰‡</a>
            <span class="mode-divider">/</span>
            <a href="#" class="mode-link" data-mode="minimal">æ–‡å­—</a>
        </div>
    </div>

    {% if page.dataset == 'all' %}
    <div class="movies-grid" id="movies-grid" data-api-base="/api/movies"></div>
    {% elsif page.year %}
    <div class="movies-grid" id="movies-grid" data-api-base="/api/movies/{{ page.year }}"></div>
    {% else %}
    <div class="movies-grid" id="movies-grid" data-api-base="/api/movies"></div>
    {% endif %}

    <!-- Loading indicator -->
    <div class="infinite-loading" style="display: none;">
        <div class="infinite-spinner">
            <div class="spinner"></div>
            <span>åŠ è½½ä¸­...</span>
        </div>
    </div>

    <!-- End indicator -->
    <div class="infinite-end" style="display: none; text-align: center; padding: 30px; color: #999;">
        <span>â€” å·²ç»åˆ°åº•å•¦ â€”</span>
    </div>

    <!-- Empty state -->
    <div class="movies-empty" id="movies-empty" style="display: none;">
        <p>ğŸ“­ æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç”µå½±</p>
    </div>

    {% else %}
    <div class="movies-empty">
        <p>ğŸ“­ æš‚æ— è§‚å½±è®°å½•</p>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.getElementById('movies-grid');
        const emptyState = document.getElementById('movies-empty');
        const modeLinks = document.querySelectorAll('.mode-link');

        if (!grid) return;

        const apiBase = grid.dataset.apiBase;
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        let allCards = [];
        let currentMode = 'normal';

        function renderMovieCard(movie) {
            const coverHtml = movie.poster
                ? `<img src="${movie.poster}" alt="${movie.title}" loading="lazy">`
                : `<div class="poster-placeholder"><span>ğŸ“½ï¸</span></div>`;

            const ratingHtml = movie.my_rating
                ? `<div class="movie-rating">${Array(5).fill(0).map((_, i) =>
                    `<span class="star ${i < movie.my_rating ? 'filled' : ''}">â˜…</span>`).join('')}</div>`
                : '';

            const dateHtml = movie.watched_date
                ? `<div class="movie-date">${movie.watched_date}</div>`
                : '';

            const origTitleHtml = movie.original_title && movie.original_title !== movie.title
                ? `<p class="movie-original-title" title="${movie.original_title}">${movie.original_title}</p>`
                : '';

            const tooltipHtml = `
                <div class="movie-tooltip">
                    ${movie.poster ? `<div class="tooltip-poster"><img src="${movie.poster}" alt="${movie.title}"></div>` : ''}
                    <div class="tooltip-content">
                        ${movie.directors && movie.directors.length > 0 ? `<p><strong>å¯¼æ¼”ï¼š</strong>${movie.directors.join(' / ')}</p>` : ''}
                        ${movie.cast && movie.cast.length > 0 ? `<p><strong>ä¸»æ¼”ï¼š</strong>${movie.cast.slice(0, 5).join(' / ')}</p>` : ''}
                        ${movie.genres && movie.genres.length > 0 ? `<p><strong>ç±»å‹ï¼š</strong>${movie.genres.join(' / ')}</p>` : ''}
                        ${movie.countries ? `<p><strong>å›½å®¶ï¼š</strong>${movie.countries}</p>` : ''}
                        ${movie.pub_date ? `<p><strong>ä¸Šæ˜ ï¼š</strong>${movie.pub_date}</p>` : ''}
                        ${movie.douban_rating ? `<p><strong>è±†ç“£ï¼š</strong><span class="rating-highlight">${movie.douban_rating}</span>${movie.rating_count ? ` (${movie.rating_count}äºº)` : ''}</p>` : ''}
                        ${movie.my_comment ? `<p class="tooltip-comment">ğŸ’¬ ${movie.my_comment}</p>` : ''}
                    </div>
                </div>
            `;

            return `
                <a href="${movie.douban_url}" target="_blank" class="movie-card"
                    data-douban-rating="${movie.douban_rating || 0}" data-date="${movie.watched_date || ''}"
                    data-pub-date="${movie.pub_date || movie.year || ''}" data-title="${movie.title || ''}"
                    data-genres="${(movie.genres || []).join(',')}" data-countries="${movie.countries || ''}">
                    <div class="movie-poster">${coverHtml}</div>
                    <div class="movie-info">
                        <h3 class="movie-title" title="${movie.title}">${movie.title}</h3>
                        ${origTitleHtml}
                        <div class="movie-meta">${ratingHtml}${dateHtml}</div>
                    </div>
                    ${tooltipHtml}
                </a>
            `;
        }

        async function loadMovies() {
            if (isLoading || !hasMore) return;

            isLoading = true;
            document.querySelector('.infinite-loading').style.display = 'block';

            try {
                const response = await fetch(`${apiBase}/page-${currentPage}.json`);
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();

                if (data.data && data.data.length > 0) {
                    data.data.forEach(movie => {
                        const cardHtml = renderMovieCard(movie);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cardHtml;
                        const card = tempDiv.firstElementChild;
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(10px)';
                        grid.appendChild(card);

                        requestAnimationFrame(() => {
                            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        });

                        allCards.push(card);
                    });

                    currentPage++;
                    hasMore = data.page < data.total_pages;
                } else {
                    hasMore = false;
                }

                if (!hasMore) {
                    document.querySelector('.infinite-end').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load movies:', error);
                document.querySelector('.infinite-loading span').textContent = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                document.querySelector('.infinite-loading').style.cursor = 'pointer';
                document.querySelector('.infinite-loading').onclick = loadMovies;
            } finally {
                isLoading = false;
                if (hasMore) {
                    document.querySelector('.infinite-loading').style.display = 'none';
                }
            }
        }

        function sortAndRender() {
            if (currentMode === 'minimal') {
                grid.classList.add('minimal-mode');
            } else {
                grid.classList.remove('minimal-mode');
            }

            const sortedCards = [...allCards].sort((a, b) => {
                const dateA = a.dataset.pubDate || '';
                const dateB = b.dataset.pubDate || '';
                return dateB.localeCompare(dateA);
            });

            grid.querySelectorAll('.year-divider').forEach(d => d.remove());

            let currentYear = null;
            sortedCards.forEach((card, index) => {
                card.style.display = '';
                card.style.order = index * 2 + 1;

                const year = card.dataset.pubDate ? card.dataset.pubDate.substring(0, 4) : 'æœªçŸ¥å¹´ä»½';
                if (year !== currentYear) {
                    currentYear = year;
                    const divider = document.createElement('div');
                    divider.className = 'year-divider';
                    divider.style.order = index * 2;
                    divider.textContent = `${year} å¹´`;
                    grid.appendChild(divider);
                }
            });

            if (emptyState) {
                emptyState.style.display = allCards.length === 0 ? 'block' : 'none';
            }
        }

        modeLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                modeLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                currentMode = this.dataset.mode;
                sortAndRender();
            });
        });

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    loadMovies();
                }
            });
        }, { rootMargin: '200px' });

        const endIndicator = document.querySelector('.infinite-end');
        if (endIndicator) {
            observer.observe(endIndicator);
        }

        loadMovies();
    });
</script>