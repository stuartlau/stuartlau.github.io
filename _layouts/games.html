---
layout: default
---

<link rel="stylesheet" href="/assets/css/games.css">

<div class="games-container">

    {% if page.dataset %}
    {% assign dataset_str = page.dataset | append: "" %}
    {% assign game_data = site.data.games[dataset_str] %}
    {% endif %}

    {% if game_data %}
    <!-- Stats -->
    <div class="games-stats">
        <span>å…±ç©è¿‡ <strong>{{ game_data | size }}</strong> æ¬¾æ¸¸æˆ</span>
        {% assign total_rating = 0 %}
        {% assign rated_count = 0 %}
        {% for game in game_data %}
        {% if game.my_rating %}
        {% assign total_rating = total_rating | plus: game.my_rating %}
        {% assign rated_count = rated_count | plus: 1 %}
        {% endif %}
        {% endfor %}
        {% if rated_count > 0 %}
        {% assign avg_rating = total_rating | divided_by: rated_count %}
        <span class="divider">|</span>
        <span>å¹³å‡è¯„åˆ† <strong>{{ avg_rating }}</strong> æ˜Ÿ</span>
        {% endif %}
    </div>

    <!-- Filters and Sort -->
    <div class="games-controls">
        <div class="games-filters">
            <label>
                <span>è±†ç“£è¯„åˆ†ï¼š</span>
                <select id="filter-rating">
                    <option value="">å…¨éƒ¨</option>
                    <option value="9">â­ 9åˆ†ä»¥ä¸Š</option>
                    <option value="8">â­ 8-9åˆ†</option>
                    <option value="7">â­ 7-8åˆ†</option>
                    <option value="0">â­ 7åˆ†ä»¥ä¸‹</option>
                </select>
            </label>
            <label>
                <span>ç±»å‹ï¼š</span>
                <select id="filter-genre">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </label>
            <label>
                <span>å¹³å°ï¼š</span>
                <select id="filter-platform">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </label>
        </div>

        <div class="games-sort">
            <label>
                <span>å‘è¡Œå¹´ä»½ï¼š</span>
                <select id="sort-by">
                    <option value="release-desc">æ–°â†’æ—§</option>
                    <option value="release-asc">æ—§â†’æ–°</option>
                </select>
            </label>
        </div>

        <div class="games-view-toggle">
            <button type="button" class="view-btn active" data-mode="normal" title="å›¾æ–‡æ¨¡å¼">ğŸ–¼ï¸</button>
            <button type="button" class="view-btn" data-mode="minimal" title="æç®€æ¨¡å¼">ğŸ“</button>
        </div>
    </div>

    <div class="games-grid" id="games-grid">
        {% for game in game_data %}
        <a href="{{ game.douban_url }}" target="_blank" class="game-card"
            data-douban-rating="{{ game.douban_rating | default: 0 }}" data-date="{{ game.played_date }}"
            data-release-date="{{ game.release_date }}" data-title="{{ game.title }}"
            data-genres="{{ game.genres | join: ',' }}" data-platforms="{{ game.platforms | join: ',' }}">

            <!-- Cover -->
            <div class="game-cover">
                {% if game.cover %}
                <img src="{{ game.cover }}" alt="{{ game.title }}" loading="lazy">
                {% else %}
                <div class="cover-placeholder">
                    <span>ğŸ®</span>
                </div>
                {% endif %}
            </div>

            <!-- Info -->
            <div class="game-info">
                <h3 class="game-title" title="{{ game.title }}">
                    {{ game.title }}
                </h3>

                <div class="game-meta">
                    {% if game.my_rating %}
                    <div class="game-rating">
                        {% for i in (1..5) %}
                        <span class="star {% if i <= game.my_rating %}filled{% endif %}">â˜…</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if game.played_date %}
                    <div class="game-date">{{ game.played_date }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Tooltip -->
            <div class="game-tooltip">
                {% if game.platforms and game.platforms.size > 0 %}
                <p><strong>å¹³å°ï¼š</strong>{{ game.platforms | join: " / " }}</p>
                {% endif %}
                {% if game.genres and game.genres.size > 0 %}
                <p><strong>ç±»å‹ï¼š</strong>{{ game.genres | join: " / " }}</p>
                {% endif %}
                {% if game.developer %}
                <p><strong>å¼€å‘ï¼š</strong>{{ game.developer }}</p>
                {% endif %}
                {% if game.publisher %}
                <p><strong>å‘è¡Œï¼š</strong>{{ game.publisher }}</p>
                {% endif %}
                {% if game.release_date %}
                <p><strong>å‘è¡Œæ—¥æœŸï¼š</strong>{{ game.release_date }}</p>
                {% endif %}
                {% if game.douban_rating %}
                <p><strong>è±†ç“£ï¼š</strong><span class="rating-highlight">{{ game.douban_rating }}</span>{% if
                    game.rating_count %} ({{ game.rating_count }}äºº){% endif %}</p>
                {% endif %}
                {% if game.my_comment %}
                <p class="tooltip-comment">ğŸ’¬ {{ game.my_comment }}</p>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- Empty state -->
    <div class="games-empty" id="games-empty" style="display: none;">
        <p>ğŸ“­ æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆ</p>
    </div>

    {% else %}
    <div class="games-empty">
        <p>ğŸ“­ æš‚æ— æ¸¸æˆè®°å½•</p>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.getElementById('games-grid');
        const emptyState = document.getElementById('games-empty');
        const filterRating = document.getElementById('filter-rating');
        const filterGenre = document.getElementById('filter-genre');
        const filterPlatform = document.getElementById('filter-platform');
        const sortBy = document.getElementById('sort-by');
        const viewBtns = document.querySelectorAll('.view-btn');

        if (!grid) return;

        const cards = Array.from(grid.querySelectorAll('.game-card'));
        let currentMode = 'normal';

        // Collect all genres and platforms
        const allGenres = new Set();
        const allPlatforms = new Set();

        cards.forEach(card => {
            const genres = card.dataset.genres?.split(',').filter(g => g.trim());
            genres?.forEach(g => allGenres.add(g.trim()));

            const platforms = card.dataset.platforms?.split(',').filter(p => p.trim());
            platforms?.forEach(p => allPlatforms.add(p.trim()));
        });

        // Populate dropdowns
        Array.from(allGenres).sort().forEach(genre => {
            const option = document.createElement('option');
            option.value = genre;
            option.textContent = genre;
            filterGenre.appendChild(option);
        });

        Array.from(allPlatforms).sort().forEach(platform => {
            const option = document.createElement('option');
            option.value = platform;
            option.textContent = platform;
            filterPlatform.appendChild(option);
        });

        function filterAndSort() {
            const ratingFilter = filterRating ? filterRating.value : '';
            const genreFilter = filterGenre ? filterGenre.value : '';
            const platformFilter = filterPlatform ? filterPlatform.value : '';
            const sortValue = sortBy ? sortBy.value : 'release-desc';

            if (currentMode === 'minimal') {
                grid.classList.add('minimal-mode');
            } else {
                grid.classList.remove('minimal-mode');
            }

            let visibleCards = cards.filter(card => {
                if (ratingFilter) {
                    const doubanRating = parseFloat(card.dataset.doubanRating) || 0;
                    const filterValue = parseInt(ratingFilter);

                    if (filterValue === 9 && doubanRating < 9) return false;
                    if (filterValue === 8 && (doubanRating < 8 || doubanRating >= 9)) return false;
                    if (filterValue === 7 && (doubanRating < 7 || doubanRating >= 8)) return false;
                    if (filterValue === 0 && doubanRating >= 7) return false;
                }

                if (genreFilter) {
                    const genres = card.dataset.genres || '';
                    if (!genres.includes(genreFilter)) return false;
                }

                if (platformFilter) {
                    const platforms = card.dataset.platforms || '';
                    if (!platforms.includes(platformFilter)) return false;
                }

                return true;
            });

            visibleCards.sort((a, b) => {
                const dateA = a.dataset.releaseDate || '';
                const dateB = b.dataset.releaseDate || '';
                return sortValue === 'release-desc'
                    ? dateB.localeCompare(dateA)
                    : dateA.localeCompare(dateB);
            });

            grid.querySelectorAll('.year-divider').forEach(d => d.remove());
            cards.forEach(card => card.style.display = 'none');

            let currentYear = null;
            visibleCards.forEach((card, index) => {
                card.style.display = '';
                card.style.order = index * 2 + 1;

                const year = card.dataset.releaseDate ? card.dataset.releaseDate.substring(0, 4) : 'æœªçŸ¥å¹´ä»½';
                if (year !== currentYear) {
                    currentYear = year;
                    const divider = document.createElement('div');
                    divider.className = 'year-divider';
                    divider.style.order = index * 2;
                    divider.textContent = `${year} å¹´`;
                    grid.appendChild(divider);
                }
            });

            if (emptyState) {
                emptyState.style.display = visibleCards.length === 0 ? 'block' : 'none';
            }
        }

        [filterRating, filterGenre, filterPlatform, sortBy].forEach(el => {
            if (el) el.addEventListener('change', filterAndSort);
        });

        viewBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                viewBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMode = this.dataset.mode;
                filterAndSort();
            });
        });

        filterAndSort();
    });
</script>