---
layout: default
---

<link rel="stylesheet" href="/assets/css/games.css">

<div class="games-container" data-theme="light">

    {% if page.dataset %}
    {% assign dataset_str = page.dataset | append: "" %}
    {% assign game_data = site.data.games[dataset_str] %}
    {% endif %}

    {% if game_data %}
    <!-- Stats -->
    <div class="games-stats">
        <span>å…±ç©è¿‡ <strong>{{ game_data | size }}</strong> æ¬¾æ¸¸æˆ</span>
        {% assign total_rating = 0 %}
        {% assign rated_count = 0 %}
        {% for game in game_data %}
        {% if game.my_rating %}
        {% assign total_rating = total_rating | plus: game.my_rating %}
        {% assign rated_count = rated_count | plus: 1 %}
        {% endif %}
        {% endfor %}
        {% if rated_count > 0 %}
        {% assign avg_rating = total_rating | divided_by: rated_count %}
        <span class="divider">|</span>
        <span>å¹³å‡è¯„åˆ† <strong>{{ avg_rating }}</strong> æ˜Ÿ</span>
        {% endif %}
    </div>

    <!-- View Toggle -->
    <div class="games-controls">
        <div class="view-mode-links">
            <a href="#" class="mode-link active" data-mode="normal">å›¾ç‰‡</a>
            <span class="mode-divider">/</span>
            <a href="#" class="mode-link" data-mode="minimal">æ–‡å­—</a>
        </div>
    </div>

    <div class="games-grid" id="games-grid" data-api-base="/api/games"></div>

    <!-- Loading indicator -->
    <div class="infinite-loading" style="display: none;">
        <div class="infinite-spinner">
            <div class="spinner"></div>
            <span>åŠ è½½ä¸­...</span>
        </div>
    </div>

    <!-- End indicator -->
    <div class="infinite-end" style="display: none; text-align: center; padding: 30px; color: #999;">
        <span>â€” å·²ç»åˆ°åº•å•¦ â€”</span>
    </div>

    <!-- Empty state -->
    <div class="games-empty" id="games-empty" style="display: none;">
        <p>ğŸ“­ æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆ</p>
    </div>

    {% else %}
    <div class="games-empty">
        <p>ğŸ“­ æš‚æ— æ¸¸æˆè®°å½•</p>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.getElementById('games-grid');
        const emptyState = document.getElementById('games-empty');
        const modeLinks = document.querySelectorAll('.mode-link');

        if (!grid) return;

        const apiBase = grid.dataset.apiBase;
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        let allCards = [];
        let currentMode = 'normal';

        function renderGameCard(game) {
            const coverHtml = game.cover
                ? `<img src="${game.cover}" alt="${game.title}" loading="lazy">`
                : `<div class="cover-placeholder"><span>ğŸ®</span></div>`;

            const ratingHtml = game.my_rating
                ? `<div class="game-rating">${Array(5).fill(0).map((_, i) =>
                    `<span class="star ${i < game.my_rating ? 'filled' : ''}">â˜…</span>`).join('')}</div>`
                : '';

            const dateHtml = game.played_date
                ? `<div class="game-date">${game.played_date}</div>`
                : '';

            const tooltipHtml = `
                <div class="game-tooltip">
                    ${game.cover ? `<div class="tooltip-poster"><img src="${game.cover}" alt="${game.title}"></div>` : ''}
                    <div class="tooltip-content">
                        ${game.platforms && game.platforms.length > 0 ? `<p><strong>å¹³å°ï¼š</strong>${game.platforms.join(' / ')}</p>` : ''}
                        ${game.genres && game.genres.length > 0 ? `<p><strong>ç±»å‹ï¼š</strong>${game.genres.join(' / ')}</p>` : ''}
                        ${game.developer ? `<p><strong>å¼€å‘ï¼š</strong>${game.developer}</p>` : ''}
                        ${game.publisher ? `<p><strong>å‘è¡Œï¼š</strong>${game.publisher}</p>` : ''}
                        ${game.release_date ? `<p><strong>å‘è¡Œæ—¥æœŸï¼š</strong>${game.release_date}</p>` : ''}
                        ${game.douban_rating ? `<p><strong>è±†ç“£ï¼š</strong><span class="rating-highlight">${game.douban_rating}</span>${game.rating_count ? ` (${game.rating_count}äºº)` : ''}</p>` : ''}
                        ${game.my_comment ? `<p class="tooltip-comment">ğŸ’¬ ${game.my_comment}</p>` : ''}
                    </div>
                </div>
            `;

            return `
                <a href="${game.douban_url}" target="_blank" class="game-card"
                    data-douban-rating="${game.douban_rating || 0}" data-date="${game.played_date || ''}"
                    data-release-date="${game.release_date || ''}" data-title="${game.title || ''}"
                    data-genres="${(game.genres || []).join(',')}" data-platforms="${(game.platforms || []).join(',')}">
                    <div class="game-cover">${coverHtml}</div>
                    <div class="game-info">
                        <h3 class="game-title" title="${game.title}">${game.title}</h3>
                        <div class="game-meta">${ratingHtml}${dateHtml}</div>
                    </div>
                    ${tooltipHtml}
                </a>
            `;
        }

        async function loadGames() {
            if (isLoading || !hasMore) return;

            isLoading = true;
            document.querySelector('.infinite-loading').style.display = 'block';

            try {
                const response = await fetch(`${apiBase}/page-${currentPage}.json`);
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();

                if (data.data && data.data.length > 0) {
                    data.data.forEach(game => {
                        const cardHtml = renderGameCard(game);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cardHtml;
                        const card = tempDiv.firstElementChild;
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(10px)';
                        grid.appendChild(card);

                        requestAnimationFrame(() => {
                            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        });

                        allCards.push(card);
                    });

                    currentPage++;
                    hasMore = data.page < data.total_pages;
                } else {
                    hasMore = false;
                }

                if (!hasMore) {
                    document.querySelector('.infinite-end').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load games:', error);
                document.querySelector('.infinite-loading span').textContent = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                document.querySelector('.infinite-loading').style.cursor = 'pointer';
                document.querySelector('.infinite-loading').onclick = loadGames;
            } finally {
                isLoading = false;
                if (hasMore) {
                    document.querySelector('.infinite-loading').style.display = 'none';
                }
            }
        }

        function sortAndRender() {
            if (currentMode === 'minimal') {
                grid.classList.add('minimal-mode');
            } else {
                grid.classList.remove('minimal-mode');
            }

            const sortedCards = [...allCards].sort((a, b) => {
                const dateA = a.dataset.releaseDate || '';
                const dateB = b.dataset.releaseDate || '';
                return dateB.localeCompare(dateA);
            });

            sortedCards.forEach((card, index) => {
                card.style.display = '';
                card.style.order = index;
            });

            if (emptyState) {
                emptyState.style.display = allCards.length === 0 ? 'block' : 'none';
            }
        }

        modeLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                modeLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                currentMode = this.dataset.mode;
                sortAndRender();
            });
        });

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    loadGames();
                }
            });
        }, { rootMargin: '200px' });

        const endIndicator = document.querySelector('.infinite-end');
        if (endIndicator) {
            observer.observe(endIndicator);
        }

        loadGames();
    });
</script>
