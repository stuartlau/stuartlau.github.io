---
layout: default
---

<link rel="stylesheet" href="/assets/css/douban.css">
<style>
    /* Ensure proper touch handling on mobile */
    .status-bubble {
        -webkit-tap-highlight-color: transparent;
    }

    /* Hide popup on desktop */
    @media (min-width: 769px) {
        .status-popup {
            display: none !important;
        }
    }
</style>

<div class="douban-feed-container">
    <nav class="douban-years-nav">
        {% assign years = "2026,2025,2024,2023,2022,2021" | split: "," %}
        {% for y in years %}
        {% if site.data.douban[y] %}
        <a href="/douban/{{ y }}.html" class="year-nav-link {% if y == page.year %}active{% endif %}">{{ y }}</a>
        {% endif %}
        {% endfor %}
    </nav>

    {% assign year_str = page.year | append: "" %}
    {% assign summary_data = site.data.douban_summaries[year_str] %}
    {% assign total_count = site.data.douban[year_str] | size %}

    <div style="text-align: right; color: #999; font-size: 0.9rem; margin-bottom: 10px;">
        共 {{ total_count }} 条广播
    </div>

    <div class="douban-summary-box"
        style="margin-bottom: 30px; padding: 25px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;">
        {% if summary_data %}
        <div class="annual-keywords" style="margin-bottom: 20px;">
            <h3 style="font-size: 1.1rem; color: #333; margin-bottom: 12px; font-weight: 600;">{{ page.year }} 年度关键词
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for keyword in summary_data.keywords %}
                <span
                    style="background: #f5f7fa; color: #555; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; border: 1px solid #e1e4e8;">{{
                    keyword }}</span>
                {% endfor %}
            </div>
        </div>

        <div class="test" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <h3 style="font-size: 1.1rem; color: #333; margin-bottom: 10px; font-weight: 600;">年度回顾</h3>
            <p style="color: #444; line-height: 1.8; font-size: 1rem; margin: 0;">{{ summary_data.summary }}</p>
        </div>
        {% else %}
        <div id="history-today-container">
            <h3 id="history-today-title" style="font-size: 1.1rem; color: #333; margin-bottom: 12px; font-weight: 600;">
                历史上的今天</h3>
            <div id="history-today-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
            <p id="history-today-empty" style="display:none; color: #999; font-size: 0.95rem;">历史上的今天暂无记录。</p>
        </div>
        <script>
            (function () {
                try {
                    // Collect all Douban data for history check
                    var historyData = [];
                    {% assign history_years = "2026,2025,2024,2023,2022,2021" | split: "," %}
                    {% for y in history_years %}
                    {% if site.data.douban[y] %}
                    {% for item in site.data.douban[y] %}
                    historyData.push({
                        time: "{{ item.time }}",
                        content: {{ item.content | jsonify }},
                year: "{{ y }}"
            });
            {% endfor %}
            {% endif %}
            {% endfor %}

            var today = new Date();
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var day = String(today.getDate()).padStart(2, '0');
            var searchDate = month + '-' + day;

            var titleEl = document.getElementById('history-today-title');
            if (titleEl) {
                titleEl.innerText = '历史上的今天 ' + searchDate;
            }

            var matches = historyData.filter(function (item) {
                // item.time format "YYYY-MM-DD HH:mm", extract MM-DD
                return item.time.substring(5, 10) === searchDate;
            });

            // Sort descending by year
            matches.sort(function (a, b) {
                return b.year - a.year;
            });

            var list = document.getElementById('history-today-list');
            var emptyMsg = document.getElementById('history-today-empty');
            var container = document.getElementById('history-today-container');

            if (list && emptyMsg) {
                if (matches.length > 0) {
                    matches.forEach(function (item) {
                        // Filter out Director/Author/Performer
                        var c = item.content || "";
                        if (c.indexOf("导演:") !== -1 || c.indexOf("表演者:") !== -1 || c.indexOf("作者:") !== -1) {
                            return;
                        }
                        var el = document.createElement('div');
                        el.style.cssText = "padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; color: #555; line-height: 1.5;";

                        // Parse content safely
                        var content = item.content;
                        // Simple HTML safety check if needed, but jsonify helps. 
                        // Douban content might contain valid HTML? Assuming text mostly.

                        el.innerHTML = '<span style="color:#2d8c3c; font-weight:600; margin-right:8px; display:inline-block; min-width:38px;">' + item.year + '</span> ' + content;
                        list.appendChild(el);
                    });
                } else {
                    emptyMsg.style.display = 'block';
                }
            }
                } catch (e) {
                console.error("Error generating History Today:", e);
            }
            }) ();
        </script>
        {% endif %}
    </div>

    <div id="douban-month-filter" class="douban-month-filter"></div>
    <div class="douban-feed-list">
        {% assign year_str = page.year | append: "" %}
        {% assign year_data = site.data.douban[year_str] %}

        {% if year_data %}
        {% assign last_month = "" %}
        {% for status in year_data %}
        {% assign content_to_check = status.content | strip %}
        {% if content_to_check contains '导演:' or
        content_to_check contains '表演者:' or
        content_to_check contains '作者:' %}
        {% continue %}
        {% endif %}
        {% assign current_month = status.time | slice: 5, 2 %}
        {% if current_month != last_month %}
        <div class="month-separator" data-month="{{ current_month }}">{{ current_month }}月</div>
        {% assign last_month = current_month %}
        {% endif %}

        <div class="douban-status-item" data-status-id="status-{{ forloop.index }}" data-month="{{ current_month }}">
            <div class="status-avatar">
                <img src="/images/douban_avatar.jpg" alt="Avatar">
            </div>
            <div class="status-bubble" data-popup-target="popup-{{ forloop.index }}">
                <div class="status-content">{{ status.content }}</div>
                <div class="status-header">
                    <span class="status-time">{{ status.time }}</span>
                </div>
            </div>
        </div>

        <!-- Popup for mobile -->
        <div class="status-popup" id="popup-{{ forloop.index }}" data-status-id="status-{{ forloop.index }}">
            <button class="status-popup-close">×</button>
            <div class="status-popup-content">
                <div class="status-popup-avatar">
                    <img src="/images/douban_avatar.jpg" alt="Avatar">
                    <span class="status-popup-time">{{ status.time }}</span>
                </div>
                <div class="status-popup-text">{{ status.content }}</div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p>No data found for year {{ year_str }} (Debug: page.year={{ page.year }})</p>
        {% endif %}
    </div>
</div>

<script>
    // Month Filter Functionality
    (function () {
        var pageYear = parseInt("{{ page.year }}");
        var now = new Date();
        var currentYear = now.getFullYear();
        var currentMonth = now.getMonth() + 1;

        var container = document.getElementById('douban-month-filter');
        if (!container) return;

        var maxMonth = 12;
        if (pageYear === currentYear) {
            if (currentMonth === 1) return; // If Jan, no need to generate filter
            maxMonth = currentMonth;
        } else if (pageYear > currentYear) {
            return;
        }

        for (var m = 1; m <= maxMonth; m++) {
            var btn = document.createElement('button');
            var mStr = (m < 10 ? '0' : '') + m;
            btn.textContent = m + '月';
            btn.className = 'month-filter-btn';
            btn.setAttribute('data-target-month', mStr);

            btn.onclick = function () {
                var target = this.getAttribute('data-target-month');
                var isActive = this.classList.contains('active');

                var allBtns = container.querySelectorAll('.month-filter-btn');
                allBtns.forEach(function (b) { b.classList.remove('active'); });

                if (!isActive) {
                    this.classList.add('active');
                    filterMonth(target);
                } else {
                    filterMonth(null);
                }
            };
            container.appendChild(btn);
        }

        function filterMonth(m) {
            var items = document.querySelectorAll('.douban-status-item');
            var separators = document.querySelectorAll('.month-separator');

            items.forEach(function (item) {
                if (!m || item.getAttribute('data-month') === m) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });

            separators.forEach(function (sep) {
                if (!m || sep.getAttribute('data-month') === m) {
                    sep.style.display = '';
                } else {
                    sep.style.display = 'none';
                }
            });
        }
    })();

    // Mobile popup functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Only run on mobile
        if (window.innerWidth > 768) return;

        // Handle popup open
        document.addEventListener('click', function (e) {
            // Find the closest status bubble that was clicked
            const bubble = e.target.closest('.status-bubble');
            if (!bubble) return;

            // Don't trigger if clicking on a link
            if (e.target.tagName === 'A') return;

            // Get the target popup ID from the data attribute
            const popupId = bubble.getAttribute('data-popup-target');
            if (!popupId) return;

            const popup = document.getElementById(popupId);
            if (popup) {
                // Hide all other popups first
                document.querySelectorAll('.status-popup').forEach(p => {
                    p.classList.remove('active');
                });

                // Show the correct popup
                document.body.style.overflow = 'hidden';
                popup.classList.add('active');

                // Prevent the click from bubbling up
                e.stopPropagation();
            }
        });

        // Handle popup close
        document.addEventListener('click', function (e) {
            const popup = e.target.closest('.status-popup');
            const closeBtn = e.target.closest('.status-popup-close');

            // If clicking the close button or outside the popup content
            if (closeBtn || (popup && e.target === popup)) {
                document.body.style.overflow = '';
                document.querySelectorAll('.status-popup').forEach(p => {
                    p.classList.remove('active');
                });
                e.stopPropagation();
            }
        });

        // Close popup when pressing ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.body.style.overflow = '';
                document.querySelectorAll('.status-popup').forEach(popup => {
                    popup.classList.remove('active');
                });
            }
        });
    });

    // Handle window resize
    window.addEventListener('resize', function () {
        if (window.innerWidth > 768) {
            document.body.style.overflow = '';
            document.querySelectorAll('.status-popup').forEach(popup => {
                popup.classList.remove('active');
            });
        }
    });
</script>