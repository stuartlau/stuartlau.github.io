---
layout: default
---

<link rel="stylesheet" href="/assets/css/douban.css">
<style>
    /* Ensure proper touch handling on mobile */
    .status-bubble {
        -webkit-tap-highlight-color: transparent;
    }

    /* Hide popup on desktop */
    @media (min-width: 769px) {
        .status-popup {
            display: none !important;
        }
    }
</style>

<div class="douban-feed-container">
    <nav class="douban-years-nav">
        {% assign years = "2026,2025,2024,2023,2022,2021" | split: "," %}
        {% for y in years %}
        {% if site.data.douban[y] %}
        <a href="/douban/{{ y }}.html" class="year-nav-link {% if y == page.year %}active{% endif %}">{{ y }}</a>
        {% endif %}
        {% endfor %}
    </nav>

    {% assign year_str = page.year | append: "" %}
    {% assign summary_data = site.data.douban_summaries[year_str] %}
    {% assign total_count = site.data.douban[year_str] | size %}

    <div style="text-align: right; color: #999; font-size: 0.9rem; margin-bottom: 10px;">
        共 {{ total_count }} 条广播
    </div>

    <div class="douban-summary-box"
        style="margin-bottom: 30px; padding: 25px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;">
        {% if summary_data %}
        <div class="annual-keywords" style="margin-bottom: 20px;">
            <h3 style="font-size: 1.1rem; color: #333; margin-bottom: 12px; font-weight: 600;">{{ page.year }} 年度关键词
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for keyword in summary_data.keywords %}
                <span
                    style="background: #f5f7fa; color: #555; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; border: 1px solid #e1e4e8;">{{
                    keyword }}</span>
                {% endfor %}
            </div>
        </div>

        <div class="test" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <h3 style="font-size: 1.1rem; color: #333; margin-bottom: 10px; font-weight: 600;">年度回顾</h3>
            <p style="color: #444; line-height: 1.8; font-size: 1rem; margin: 0;">{{ summary_data.summary }}</p>
        </div>
        {% else %}
        <div id="history-today-container">
            <h3 id="history-today-title" style="font-size: 1.1rem; color: #333; margin-bottom: 12px; font-weight: 600;">
                历史上的今天</h3>
            <div id="history-today-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
            <p id="history-today-empty" style="display:none; color: #999; font-size: 0.95rem;">历史上的今天暂无记录。</p>
        </div>
        <script>
            (function () {
                try {
                    // Collect all Douban data for history check
                    var historyData = [];
                    {% assign history_years = "2026,2025,2024,2023,2022,2021" | split: "," %}
                    {% for y in history_years %}
                    {% if site.data.douban[y] %}
                    {% for item in site.data.douban[y] %}
                    historyData.push({
                        time: "{{ item.time }}",
                        content: {{ item.content | jsonify }},
                year: "{{ y }}"
            });
            {% endfor %}
            {% endif %}
            {% endfor %}

            var today = new Date();
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var day = String(today.getDate()).padStart(2, '0');
            var searchDate = month + '-' + day;

            var titleEl = document.getElementById('history-today-title');
            if (titleEl) {
                titleEl.innerText = '历史上的今天 ' + searchDate;
            }

            var matches = historyData.filter(function (item) {
                // item.time format "YYYY-MM-DD HH:mm", extract MM-DD
                return item.time.substring(5, 10) === searchDate && item.year !== String(today.getFullYear());
            });

            // Sort descending by year
            matches.sort(function (a, b) {
                return b.year - a.year;
            });

            var list = document.getElementById('history-today-list');
            var emptyMsg = document.getElementById('history-today-empty');
            var container = document.getElementById('history-today-container');

            if (list && emptyMsg) {
                if (matches.length > 0) {
                    matches.forEach(function (item) {
                // Filter out Director/Author/Performer
                        var c = item.content || "";
                        // Check for common keywords with optional colon (English/Chinese) and spaces
                        var filterRegex = /(导演|表演者|作者|主演|类型|出版)\s*[:：]/;
                        if (filterRegex.test(c)) {
                            return;
                        }
                        var el = document.createElement('div');
                        el.style.cssText = "padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; color: #555; line-height: 1.5;";

                        // Parse content safely
                        var content = item.content;
                        // Simple HTML safety check if needed, but jsonify helps. 
                        // Douban content might contain valid HTML? Assuming text mostly.

                        el.innerHTML = '<span style="color:#2d8c3c; font-weight:600; margin-right:8px; display:inline-block; min-width:38px;">' + item.year + '</span> ' + content;
                        list.appendChild(el);
                    });
                } else {
                    emptyMsg.style.display = 'block';
                }
            }
                } catch (e) {
                console.error("Error generating History Today:", e);
            }
            }) ();
        </script>
        {% endif %}
    </div>

    <div id="douban-month-filter" class="douban-month-filter"></div>
    <div class="douban-feed-list">
        {% assign year_str = page.year | append: "" %}
        {% assign year_data = site.data.douban[year_str] %}

        {% if year_data %}
        {% assign last_month = "" %}
        {% for status in year_data %}
        {% assign content_to_check = status.content | strip %}
        {% if content_to_check contains '导演:' or
        content_to_check contains '表演者:' or
        content_to_check contains '作者:' %}
        {% continue %}
        {% endif %}
        {% assign current_month = status.time | slice: 5, 2 %}
        {% if current_month != last_month %}
        <div class="month-separator" data-month="{{ current_month }}">{{ current_month }}月</div>
        {% assign last_month = current_month %}
        {% endif %}

        <div class="douban-status-item" data-status-id="status-{{ forloop.index }}" data-month="{{ current_month }}">
            <div class="status-avatar">
                <img src="/images/douban_avatar.jpg" alt="Avatar">
            </div>
            <div class="status-bubble" data-popup-target="popup-{{ forloop.index }}">
                <div class="status-content">{{ status.content }}</div>

                {% if status.images and status.images.size > 0 %}
                <div class="status-images">
                    {% for img in status.images %}
                    <div class="status-image-thumb" style="background-image: url('{{ img }}');"></div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="status-footer">
                    <span class="status-time">{{ status.time }}</span>
                    {% if status.ai_comments %}
                    <span class="comment-link" onclick="event.stopPropagation(); toggleComments(this)">评论({{
                        status.ai_comments | size }})</span>
                    {% endif %}
                    <span class="comment-link reply-btn" onclick="event.stopPropagation(); toggleGiscus(this)">回复</span>
                </div>
                {% if status.ai_comments %}
                <div class="comment-box" onclick="event.stopPropagation()">
                    {% for comment in status.ai_comments %}
                    <div class="comment-item">
                        <div class="comment-content-wrapper">
                            <span class="comment-author">{{ comment.author }}:</span>
                            <span class="comment-text">{{ comment.content }}</span>
                            <!-- <span class="comment-meta">{{ comment.timestamp }}</span> Optional timestamp if needed -->
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <!-- Giscus Container -->
                {% capture giscus_term %}douban-{{ status.time | slugify }}-{{ status.content | slugify | slice: 0, 10
                }}{% endcapture %}
                <div class="giscus-wrapper" data-term="{{ giscus_term }}" style="display:none; margin-top: 15px;"
                    onclick="event.stopPropagation()"></div>
            </div>
        </div>

        <!-- Popup for mobile -->
        <div class="status-popup" id="popup-{{ forloop.index }}" data-status-id="status-{{ forloop.index }}">
            <button class="status-popup-close">×</button>
            <div class="status-popup-content">
                <div class="status-popup-avatar">
                    <img src="/images/douban_avatar.jpg" alt="Avatar">
                    <span class="status-popup-time">{{ status.time }}</span>
                </div>
                <div class="status-popup-text">{{ status.content }}</div>

                {% if status.images and status.images.size > 0 %}
                <div class="status-popup-images">
                    {% for img in status.images %}
                    <img src="{{ img }}" class="status-popup-image-full">
                    {% endfor %}
                </div>
                {% endif %}

                {% if status.ai_comments %}
                <div class="status-popup-comments">
                    <div class="status-popup-comment-title">朋友圈热评</div>
                    {% for comment in status.ai_comments %}
                    <div class="status-popup-comment-item">
                        <div class="status-popup-comment-header">
                            <span class="status-popup-comment-author">{{ comment.author }}</span>
                            <span class="status-popup-comment-time">{{ comment.timestamp }}</span>
                        </div>
                        <div class="status-popup-comment-text">{{ comment.content }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p>No data found for year {{ year_str }} (Debug: page.year={{ page.year }})</p>
        {% endif %}
    </div>
</div>

<script>
    // Month Filter Functionality
    (function () {
        var pageYear = parseInt("{{ page.year }}");
        var now = new Date();
        var currentYear = now.getFullYear();
        var currentMonth = now.getMonth() + 1;

        var container = document.getElementById('douban-month-filter');
        if (!container) return;

        var maxMonth = 12;
        if (pageYear === currentYear) {
            if (currentMonth === 1) return; // If Jan, no need to generate filter
            maxMonth = currentMonth;
        } else if (pageYear > currentYear) {
            return;
        }

        for (var m = 1; m <= maxMonth; m++) {
            var btn = document.createElement('button');
            var mStr = (m < 10 ? '0' : '') + m;
            btn.textContent = m + '月';
            btn.className = 'month-filter-btn';
            btn.setAttribute('data-target-month', mStr);

            btn.onclick = function () {
                var target = this.getAttribute('data-target-month');
                var isActive = this.classList.contains('active');

                var allBtns = container.querySelectorAll('.month-filter-btn');
                allBtns.forEach(function (b) { b.classList.remove('active'); });

                if (!isActive) {
                    this.classList.add('active');
                    filterMonth(target);
                } else {
                    filterMonth(null);
                }
            };
            container.appendChild(btn);
        }

        // Auto-select the first month button (representing the latest month)
        // This ensures not all feed items are loaded/shown at once
        var firstBtn = container.querySelector('.month-filter-btn');
        if (firstBtn) {
            firstBtn.click();
        }

        function filterMonth(m) {
            var items = document.querySelectorAll('.douban-status-item');
            var separators = document.querySelectorAll('.month-separator');

            items.forEach(function (item) {
                if (!m || item.getAttribute('data-month') === m) {
                    item.style.display = '';
                    // Lazy load images if we were using data-src? 
                    // For now browser native lazy loading is adding implicitly by Jekyll often, 
                    // or we can add it to template.
                } else {
                    item.style.display = 'none';
                }
            });

            separators.forEach(function (sep) {
                if (!m || sep.getAttribute('data-month') === m) {
                    sep.style.display = '';
                } else {
                    sep.style.display = 'none';
                }
            });
        }
    })();

    // Desktop Lightbox Functionality
    document.addEventListener('DOMContentLoaded', function () {
        if (window.innerWidth <= 768) return; // Skip on mobile, use popup

        // Create lightbox container
        var lightbox = document.createElement('div');
        lightbox.id = 'desktop-lightbox';
        lightbox.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; cursor:pointer;';
        lightbox.innerHTML = '<img src="" style="max-width:90%; max-height:90%; border-radius:4px; box-shadow:0 0 20px rgba(0,0,0,0.5);">';
        document.body.appendChild(lightbox);

        var lbImg = lightbox.querySelector('img');

        lightbox.addEventListener('click', function () {
            lightbox.style.display = 'none';
        });

        // Add click event to all status thumbnails
        document.body.addEventListener('click', function (e) {
            if (e.target.classList.contains('status-image-thumb')) {
                // Get URL from background-image style
                var bg = e.target.style.backgroundImage;
                // bg is like 'url("...")'
                var url = bg.slice(5, -2);
                if (url) {
                    lbImg.src = url;
                    lightbox.style.display = 'flex';
                }
            }
        });
    });

    // Mobile popup functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Only run on mobile
        if (window.innerWidth > 768) return;

        // Handle popup open
        document.addEventListener('click', function (e) {
            // Find the closest status bubble that was clicked
            const bubble = e.target.closest('.status-bubble');
            if (!bubble) return;

            // Don't trigger if clicking on a link
            if (e.target.tagName === 'A') return;

            // Don't trigger if clicking on reply or comments
            if (e.target.closest('.status-footer') || e.target.closest('.comment-box') || e.target.closest('.giscus-wrapper')) return;

            // Get the target popup ID from the data attribute
            const popupId = bubble.getAttribute('data-popup-target');
            if (!popupId) return;

            const popup = document.getElementById(popupId);
            if (popup) {
                // Hide all other popups first
                document.querySelectorAll('.status-popup').forEach(p => {
                    p.classList.remove('active');
                });

                // Show the correct popup
                document.body.style.overflow = 'hidden';
                popup.classList.add('active');

                // Prevent the click from bubbling up
                e.stopPropagation();
            }
        });

        // Handle popup close
        document.addEventListener('click', function (e) {
            const popup = e.target.closest('.status-popup');
            const closeBtn = e.target.closest('.status-popup-close');

            // If clicking the close button or outside the popup content
            if (closeBtn || (popup && e.target === popup)) {
                document.body.style.overflow = '';
                document.querySelectorAll('.status-popup').forEach(p => {
                    p.classList.remove('active');
                });
                e.stopPropagation();
            }
        });

        // Close popup when pressing ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.body.style.overflow = '';
                document.querySelectorAll('.status-popup').forEach(popup => {
                    popup.classList.remove('active');
                });
            }
        });
    });

    // Handle window resize
    window.addEventListener('resize', function () {
        if (window.innerWidth > 768) {
            document.body.style.overflow = '';
            document.querySelectorAll('.status-popup').forEach(popup => {
                popup.classList.remove('active');
            });
        }
    });
    // Toggle Comments for Web
    function toggleComments(el) {
        // Find the comment box within the same status bubble
        var bubble = el.closest('.status-bubble');
        var box = bubble.querySelector('.comment-box');
        if (box) {
            if (box.style.display === 'block') {
                box.style.display = 'none';
            } else {
                box.style.display = 'block';
            }
        }
    }

    // Toggle Giscus
    function toggleGiscus(el) {
        var bubble = el.closest('.status-bubble');
        var wrapper = bubble.querySelector('.giscus-wrapper');
        if (wrapper) {
            if (wrapper.style.display === 'block') {
                wrapper.style.display = 'none';
            } else {
                wrapper.style.display = 'block';
                if (!wrapper.hasAttribute('data-loaded')) {
                    var term = wrapper.getAttribute('data-term');
                    var script = document.createElement('script');
                    script.src = "https://giscus.app/client.js";
                    script.setAttribute("data-repo", "stuartlau/stuartlau.github.io");
                    script.setAttribute("data-repo-id", "R_kgDOOf5c7g");
                    script.setAttribute("data-category", "Announcements");
                    script.setAttribute("data-category-id", "DIC_kwDOOf5c7s4Cz_Oz");
                    script.setAttribute("data-mapping", "specific");
                    script.setAttribute("data-term", term);
                    script.setAttribute("data-strict", "0");
                    script.setAttribute("data-reactions-enabled", "1");
                    script.setAttribute("data-emit-metadata", "0");
                    script.setAttribute("data-input-position", "top");
                    script.setAttribute("data-theme", document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');
                    script.setAttribute("data-lang", "zh-CN");
                    script.setAttribute("crossorigin", "anonymous");
                    script.setAttribute("async", "");

                    wrapper.appendChild(script);
                    wrapper.setAttribute('data-loaded', 'true');
                }
            }
        }
    }
</script>